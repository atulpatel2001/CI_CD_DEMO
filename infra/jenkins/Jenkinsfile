pipeline {
  agent any

  environment {
    NAMESPACE = 'dev'
    ENV = 'dev'
  }

  stages {
    stage('Detect Changed Microservices') {
      steps {
        script {
          // üëá This is CRITICAL to compare with latest remote branch
          sh "git remote set-url origin https://github.com/atulpatel2001/CI_CD_DEMO.git"
          sh "git fetch origin master"

          // üëá Do the actual diff
          def changedFiles = sh(script: 'git diff --name-only origin/master...HEAD', returnStdout: true).trim().split('\n')

          echo "[DEBUG] Changed files: ${changedFiles}"

          def serviceDirs = changedFiles.findAll {
            it.startsWith('user_service/') || it.startsWith('personal_expense/')
          }.collect {
            it.split('/')[0] // üëà Use 0 here, not 1, if top-level folder
          }.unique()

          if (serviceDirs.isEmpty()) {
            echo "[INFO] No microservice changes detected."
            currentBuild.result = 'SUCCESS'
            return
          }

          env.CHANGED_SERVICES = serviceDirs.join(',')
          echo "[INFO] Detected changed microservices: ${env.CHANGED_SERVICES}"
        }
      }
    }

 stage('Build & Push Docker Image') {
      when {
        expression { env.CHANGED_SERVICES != null && env.CHANGED_SERVICES != '' }
      }
      steps {
        script {
          def services = env.CHANGED_SERVICES.split(',')
          for (svc in services) {
            echo "[‚öôÔ∏è BUILDING] ${svc} with Maven + Jib..."
            dir("/${svc}") {
              sh "mvn clean package jib:build"
            }
          }
        }
      }
    }
    stage('Approve Production Deploy') {
      when {
        expression { env.BRANCH_NAME == 'master' && env.NAMESPACE == 'prod' }
      }
      steps {
        input message: 'Approve deployment to PRODUCTION?'
      }
    }

    stage('Deploy Changed Microservices') {
      when {
        expression { env.CHANGED_SERVICES != null && env.CHANGED_SERVICES != '' }
      }
      steps {
        script {
          def services = env.CHANGED_SERVICES.split(',')

          for (svc in services) {
            def chartPath = "./services/${svc}/helm/helm-chart"
            def valuesPath = "./infra/helm-charts/enviroment/${env.ENV}/${svc}/values.yaml"

            echo "[üîç] Validating Helm chart for ${svc}..."
            sh "helm lint ${chartPath}"
            sh "helm template ${svc} ${chartPath} -f ${valuesPath} --namespace ${env.NAMESPACE}"

            echo "[üöÄ] Deploying ${svc}..."
            sh "./jenkins/deploy.sh ${svc} ${env.ENV} ${env.NAMESPACE}"
          }
        }
      }
    }
  }
}
